var $cuerpo = $('body');
var $ventana = $(window);
var $widthVentana = $ventana.width();
var $htmlcuerpo = $('html, body');



function touchSlider(ulSlider, botonesNav) {
    var xDown = null;
    var yDown = null;
    ulSlider.on('touchstart', function(evt) {
        xDown = evt.touches[0].clientX;
        yDown = evt.touches[0].clientY;
    });
    ulSlider.on('touchmove', function(evt) {
        if (!xDown || !yDown) {
            return;
        }
        var xUp = evt.touches[0].clientX;
        var yUp = evt.touches[0].clientY;
        var xDiff = xDown - xUp;
        var yDiff = yDown - yUp;
        if (Math.abs(xDiff) > Math.abs(yDiff)) { // si se mueve derecha o izquierda
            evt.preventDefault();
            ulSlider.trigger('mouseenter');
            var nLis = botonesNav.length;
            var $elLiActivo = itemActivo(botonesNav);
            if (xDiff > 0) { // izquierda
                if (($elLiActivo + 1) !== nLis) {
                    botonesNav.eq($elLiActivo + 1).trigger('click');
                    ulSlider.trigger('mouseleave');
                } else {
                    botonesNav.eq(0).trigger('click');
                    ulSlider.trigger('mouseleave');
                }
            } else { // derecha
                if ($elLiActivo !== 0) {
                    botonesNav.eq($elLiActivo - 1).trigger('click');
                    ulSlider.trigger('mouseleave');
                }
            }
        }
        xDown = null;
        yDown = null;
    });
}

function itemActivo(losLi) { // refactorizar esto (nueva idea para la función).
    var nLis = losLi.length;
    for (var s = 0; s < nLis; s++) {
        if (losLi.eq(s).hasClass('active')) {
            return s;
        }
    }
}

function creaBullets(numeroLis, contentBullets) {
    if (contentBullets.length) {
        // borro los botones previos que existan.
        if (contentBullets.find('> *').length) {
            contentBullets.empty();
        }
        // Creo los botones
        var b = 0;
        while (b < numeroLis) {
            contentBullets.append('<button></button>');
            b++
        }
    } else {
        console.log('Error, Nav no found. You need put nav');
    }
}



function creaIframeVideo(elBoton) {
    var $urlVideo = elBoton.attr('data-video');
    if ($urlVideo !== undefined) {
        var $urlVideo = $urlVideo.toString();
        if ($urlVideo.indexOf('youtube') !== -1) { // es un video de Youtube, EJM: https://www.youtube.com/watch?v=9RBSH7Xvn3Q
            var srcVideo = 'https://www.youtube.com/embed/' + $urlVideo.substring($urlVideo.length - 11, $urlVideo.length) + '?autoplay=1';
        } else if ($urlVideo.indexOf('vimeo') !== -1) { // es un video de Vimeo, EJM: https://vimeo.com/206418873
            var srcVideo = 'https://player.vimeo.com/video/' + $urlVideo.substring(($urlVideo.indexOf('.com') + 5), $urlVideo.length).replace('/', '');
        } else {
            alert('El video asignado no es de Youtuve ni de Vimeo, recuerda ingresar el enlace completo del video en el formato correcto.\n - Youtube: https://www.youtube.com/watch?v=9RBSH7Xvn3Q\n - Vimeo: https://vimeo.com/206418873');
            return false;
        }
        return '<iframe src="' + srcVideo + '" frameborder="0" allowfullscreen></iframe>';
    } else {
        alert('No se tiene un video asignado.');
        return false;
    }
}
    

/* video in modal */


// 2.- Boton cerrar 'modal video'
$cuerpo.on('click', '#close-video', function() { 
    var $elParent = $(this).parent();
    $elParent.fadeOut();
    setTimeout(function() {
        $elParent.remove();
    }, 1200)
});

mostrar_fullvideo( '#slideHome' , '.open-video' );

function mostrar_fullvideo( wrapper , button ){
    var $videoseox = $( wrapper );
    if ($videoseox.length) {
        $videoseox.find( button ).on('click', function() {
            var $iframeVideo = creaIframeVideo($(this));
            if ($iframeVideo) {
                $cuerpo.append('<div id="modal-video">' + $iframeVideo + '<button id="close-video"><span class="icon-close2">x</span></button></div>');
            }
        });
    }
}

function mostrar_video( wrapper , button ){
    var $videoseox = $( wrapper );
    if ($videoseox.length) {
        $videoseox.find( button ).on('click', function() {
            var $iframeVideo = creaIframeVideo($(this));
            if ($iframeVideo) {
                if ($cuerpo.width() < 768) {
                    $(this).parent().append('<div class="video-inside">' + $iframeVideo + '<button class="close-vi"><span class="icon-close"></span></button></div>');
                } else {
                    $cuerpo.append('<div id="modal-video">' + $iframeVideo + '<button id="close-video"><span class="icon-close2"></span></button></div>');
                }
            }
        });

        // Boton cerrar
        $videoseox.find('.video').on('click', '.close-vi', function() {
            var $elParent = $(this).parent();
            $elParent.fadeOut();
            setTimeout(function() {
                $elParent.remove();
            }, 1200)
        });
    }
}




/***/

function next_section( section_name ){
    // Boton 'Next Section'
    var $nextSection = $( section_name );
    if ($nextSection.length) {
        $nextSection.on('click', function() {
            $htmlcuerpo.animate({
                scrollTop: ($(this).offset().top + 60)
            }, 800);
        });
    }
    
}
(function() {
    var $ventana = $(window);
    var $cuerpo = $('body');
    var $htmlcuerpo = $('html, body');
    var $transitionTime = 6500;
    
    
    $ventana.on('load', function() {
        // Mostrando la primera imagen y activando el slider del Main
        if ($cuerpo.hasClass('home')) {
            //apareceImagen($lisSlider.eq(0)); 
        }
    });
    
    
    // Slider del main (Home)
    var $sliderMain = $('#slideHome');
    if ($sliderMain.length) {
        var $ulSlider = $sliderMain.find('> ul')
        var $lisSlider = $ulSlider.find('> li');
        var nLis = $lisSlider.length;
        if (nLis > 1) {
            // Dandole ancho relativo al Ul y a los Li.
            if($sliderMain.hasClass('swipe')){
                $ulSlider.css('width', (nLis * 100) + '%');
                $lisSlider.css('width', (100 / nLis) + '%');
            }else{
                if( !$sliderMain.hasClass('fade')){
                    $sliderMain.addClass('fade');
                }
            }
            
            $lisSlider.eq(0).addClass('active').siblings().removeClass('active');
            apareceImagen($lisSlider.eq(0));
            
            // creando Bullets
            var $bltsSliderMain = $sliderMain.find('.bullets');
            creaBullets(nLis, $bltsSliderMain);
            // Agregando .active al primer Bullet
            var $bulletsSliderMain = $bltsSliderMain.find('button');
            $bulletsSliderMain.eq(0).addClass('active');
            // Boton next y prev
            var $btnNext = $sliderMain.find('.next');
            $btnNext.on('click', function() {
                if (!$ulSlider.hasClass('swiping')) {
                    var $elLiActivo = itemActivo($bulletsSliderMain);
                    if (($elLiActivo + 1) !== $bulletsSliderMain.length) {
                        $bulletsSliderMain.eq($elLiActivo + 1).trigger('click');
                        $lisSlider.eq($elLiActivo);
                    } else {
                        //$btnsNavNbh.eq(0).trigger('click');
                        $bulletsSliderMain.eq(0).trigger('click');
                    }
                }
            });
            var $btnPrev = $sliderMain.find('.prev');
            $btnPrev.on('click', function() {
                if (!$ulSlider.hasClass('swiping')) {
                    var $elLiActivo = itemActivo($bulletsSliderMain);
                    if ($elLiActivo !== 0) {
                        $bulletsSliderMain.eq($elLiActivo - 1).trigger('click');
                    }else{
                        $bulletsSliderMain.eq($elLiActivo - 1).trigger('click');
                    }
                }
            });
            // Agregando función Click a los bullets
            $bulletsSliderMain.on('click', function() {
                if (!$ulSlider.hasClass('swiping')) {
                    //console.log('hice click, Hora: ' + getDateTime());
                    $ulSlider.addClass('swiping');
                    var $indexButton = $(this).index();
                    if($sliderMain.hasClass('swipe')){
                        $ulSlider.css('margin-left', '-' + ($indexButton * 100) + '%');
                    }

                    apareceImagen($lisSlider.eq($indexButton));
                    $lisSlider.eq($indexButton).addClass('active').siblings().removeClass('active');
                    $bulletsSliderMain.eq($indexButton).addClass('active').siblings().removeClass('active');
                    $ulSlider.removeClass('swiping');
                }
            });
            // AutoPlay.
            function autoPlayM() {
                //console.log('AutoPlay, Hora: ' + getDateTime());
                var $elLiActivo = itemActivo($bulletsSliderMain);
                if (($elLiActivo + 1) !== $bulletsSliderMain.length) {
                    $bulletsSliderMain.eq($elLiActivo + 1).trigger('click');
                } else {
                    $bulletsSliderMain.eq(0).trigger('click');
                }
            };
            var autoPlaySliderMain;
            // Hover en barra ploma y en el nav de bullets
            $sliderMain.find('.gray-bar, .nav').mouseenter(function() {
                if ($ulSlider.hasClass('interval')) {
                    clearInterval(autoPlaySliderMain);
                    $ulSlider.removeClass('interval').addClass('hover');
                }
            }).mouseleave(function() {
                if (!$ulSlider.hasClass('interval')) {
                    $ulSlider.removeClass('hover').addClass('interval');
                    autoPlaySliderMain = setInterval(autoPlayM, $transitionTime);
                    //console.log('salí del hover');
                }
            });
            // funciones útiles
            function apareceImagen(li) {
                var $elLi = li.find('> img');
                var $srcOriginal = $elLi.attr('original-src');
                if ($srcOriginal !== undefined) {
                    clearInterval(autoPlaySliderMain);
                    $ulSlider.removeClass('interval');
                    $elLi.attr('src', $srcOriginal).removeAttr('original-src');
                    li.addClass('loading');
                    $elLi.on('load', function() {
                        $(this).css('opacity', '1');
                        if (li.hasClass('loading')) {
                            li.removeClass('loading');
                        }
                        if (!$ulSlider.hasClass('interval') && !$ulSlider.hasClass('hover')) {
                            //console.log('puse interval primero')
                            autoPlaySliderMain = setInterval(autoPlayM, $transitionTime);
                            $ulSlider.addClass('interval');
                        }
                    });
                } else {
                    if (!$ulSlider.hasClass('interval') && !$ulSlider.hasClass('hover')) {
                        //console.log('puse interval de nuevo')
                        autoPlaySliderMain = setInterval(autoPlayM, $transitionTime);
                        $ulSlider.addClass('interval');
                    }
                }
            }

            touchSlider($ulSlider, $bulletsSliderMain);
        } else {
            $sliderMain.find('.nav').css('display', 'none');
        }
    };
    
    
    // Boton para subir al top de la web
    var $toUp = $('#toup');
    if ($toUp.length) {
        $toUp.on('click', function() {
            $htmlcuerpo.animate({
                scrollTop: 0
            }, 800);
        })
    }
    
    
}());
(function() {
    /*SLIDER*/
	var slide = $('#slider'); // padre del slider

    var ulphotos = $('#photos ul');
    var numList = ulphotos.find('li').length;
	var numListSlide = slide.find('> li').length; // count Li
	var $navigation = $('#navigation');

    var find_li_photos = $('#photos').find('li'); // array
    
	ulphotos.css('width', numList * 100 + '%');
	slide.css('width', numList * 100 + '%');


	if ($navigation.length > 0) { /* If the element exits */
		$navigation.on('click', 'button', function(){
			var bclicked = $(this).index();
			$navigation.find('button').eq(bclicked).addClass('active').siblings().removeClass('active');
            
			if (bclicked != 0) {
				ulphotos.css('margin-left', '-' + (bclicked * 100) + '%');
				slide.css('margin-left', '-' + (bclicked * 100) + '%');
                
                var find_index_img = find_li_photos.eq(bclicked).find('img');
                var find_attr_bclicked = find_index_img.attr('data-img'); // captura el atributo - get 
                
                if(find_attr_bclicked != undefined ){
                    find_index_img.attr('src', find_attr_bclicked).removeAttr('data-img'); // asigna el atributo, set- Luego remueve el atributo
                    setTimeout( function() {
                        find_index_img.css('opacity','1');
                    }, 250);
                }
			} else {
				ulphotos.css('margin-left', '0');
				slide.css('margin-left', '0');
			}
		});
	};
	for (var i = 0 ;  i < numListSlide  ; i++){
		$navigation.append('<button></button>'); 
	}
	$navigation.find('button').eq('0').addClass('active');
    /*FIN SLIDER*/



}());
(function() {

	
	var $cuerpo = $('body');
	var element1 = $('#main'); //sección slider
	var element2 = $('#listings');
	var element3 = $('#section3');
	var element4 = $('#section4');
	
	$(window).on('load', function() {
		/*Al cargar la web debería ejecutarse lo siguiente*/
		//indice de section
		var $nSections = $cuerpo.find('.toload');
		for (var i = 0; i < $nSections.length ; i++ ) {
			//cargar la primera section
			$cuerpo.find('.toload').eq(0).removeClass('.toload').addClass('loaded').siblings().removeClass('loaded');

			console.log(i);
			switch (i) {
				case 0:
					get_section_active(element1);
					break;
				case 1:
					get_section_active(element2);
					var find_li_photos = $('#photos').find('li'); // array
                    var find_first_index_img = find_li_photos.eq(0).find('img'); 
                    //ecuentra el primer li y luego busca su respectivo img 
                    var find_attr = find_first_index_img.attr('data-img'); 
                    if ( find_attr != undefined ) {
                        find_first_index_img.attr('src', find_attr).removeAttr('data-img').css('opacity','1');
                    }
					break;
				case 2:
					get_section_active(element3);
					break;
				case 3:
					get_section_active(element4);
					break;
			}
		}
	});
	
	
	
	function seccion_visible(element) {
		var visible = true;
		var windowTop = $(document).scrollTop();
		var windowBottom = windowTop + window.innerHeight;            
		var elementPositionTop = element.offset().top;
		var elementPositionBottom = elementPositionTop + element.height();

		if( element.length ){
			if (elementPositionTop > windowBottom || elementPositionBottom < windowTop) {
				console.log('estoy fuera de la sección');
				//opciona: cuando ya no esté visible la sección quitarle la clase general active
				element.removeClass('loaded');
				return visible = false;
			}
			else{
				console.log('estoy dentro de la sección');
				//element.addClass('active').siblings().removeClass('active');
				element.addClass('loaded').removeClass('toload');
				
				aparecerImagenes(element);
				obtenerHash(element);

				return visible;
			}
			return visible;				
		}
		else{
			console.log('No se encontró la sección');
		}
	}

	function get_section_active(element) {
		$(window).on('scroll resize', function() {
			console.log(seccion_visible(element));
		});
	}

	function aparecerImagenes(element){
		var imagenes = element.find('img.lazy');
		var url = imagenes.attr('data-img');
		imagenes.each( function() {
			$(this).removeAttr('data-img').attr('src', url);
		});
	}

	function obtenerHash(element){
		var hash = window.location.hash;
		console.log(hash);


		var section = $.map($("section"), function (event) {
		    var $event = $(event);
		    var pos = $event.position();
		    return {
		        top: pos.top - 550,
		        bottom: pos.top - 550 + $event.height(),
		        hash: $event.attr('id')
		    };
		});
	}

}());
/***/
(function() {
    //@prepros-prepend functions.js
    //@prepros-prepend home/sliderprincipal.js
    //@prepros-prepend home/exclusive-listing.js
    //@prepros-prepend home/scroolltoload.js

    
}());
